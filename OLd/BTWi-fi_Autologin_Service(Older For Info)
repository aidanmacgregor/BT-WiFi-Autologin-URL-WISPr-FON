#!/bin/sh /etc/rc.common
# ^---: /etc/rc.common contains all the logic to make this a "real" service, including enabling/disabling it on startup

###############- BTWifi Openwrt Autologin Script -###############
##############-- By: Aidan Macgregor (May 2022) --###############
# https://github.com/aidanmacgregor/BT_Wi-Fi_Autologin_MACRODROID-WISPr-HTTP_POST-HTTP_GET-OpenWRT
# (Tested On LEDE 17.01.7, OpenWrt 19.07.10 & 21.02.3)

############### INFO ###############

#### OpenWrt Install This Required Package:					

# 	libustream-mbedtls
# (libustream-mbedtls Not Needed On OpenWRT 21.X as Wolf SSL included)

#### Copy This File To /etc/init.d/
# 	Use WinSCP To Tranfer File & Give 755 (Execute) permissions

#### Manual Run & Stop (Stopping Also Signs The Account Out)
# 	Click Start on the service in LUCI (System > Startup)

#### Start On Boot
#	Enable the service in LUCI (System > Startup)

#### In The SETTINGS Section Choose Your Account Type & Add Email & Password

#### Account Type:
# 	1 = BT Home Broadband
# 	2 = BT Buisness Broadband
# 	3 = BT Wi-Fi Account

###############- SETTINGS -###############

ACCOUNTTYPE=1
USERNAME=
PASSWORD=

###############- OPTIONAL -###############

PINGDNS=8.8.8.8
PING2URL=www.google.com
LOGPATH=/BTWi-fi_Autologin_Service_LOG.txt

##########################################
#####---- DO NOT EDIT BELOW HERE ----#####
##########################################

START=99
STOP=1
PIDFILE=/var/run/btwifi.pid

btwifi_loop(){
while true
do
if [[ "92" -ge "92" ]]; then
	echo "$(tail -92 $LOGPATH)" > $LOGPATH
fi
	if ! ping -c 1 -W 1 $PINGDNS 2>/dev/null >/dev/null			 
	then
		logger -t BTWi-fi_Autologin_Service "Ping 1 DNS Fail"	
		echo "$(date) Ping 1 DNS Fail" >> $LOGPATH
		if ! ping -c 1 -W 1 $PING2URL 2>/dev/null >/dev/null				 
		then
			logger -t BTWi-fi_Autologin_Service "Ping 2 URL Fail"
			echo "$(date) Ping 1 DNS Fail" >> $LOGPATH
			if [ "$ACCOUNTTYPE" = "1" ]
			then
				logger -t BTWi-fi_Autologin_Service "$(date) Offline, attempting login URL 1 (BT Home Broadband Account)"
				echo "$(date) Offline, attempting login URL 1 (BT Home Broadband Account)" >> $LOGPATH
				wget -T 2 -O /dev/null --post-data "username=$USERNAME&password=$PASSWORD" 'https://192.168.23.21:8443/tbbLogon'
			elif [ "$ACCOUNTTYPE" = "2" ]
			then
				logger -t BTWi-fi_Autologin_Service "$(date) Offline, attempting login URL 2 (BT Buisness Broadband Account)"
				echo "$(date) Offline, attempting login URL 2 (BT Buisness Broadband Account)" >> $LOGPATH
				wget -T 2 -O /dev/null --post-data "username=$USERNAME&password=$PASSWORD" 'https://192.168.23.21:8443/ante?partnerNetwork=btb'
			elif [ "$ACCOUNTTYPE" = "3" ]
			then
				logger -t BTWi-fi_Autologin_Service "$(date) Offline, attempting login URL 3 (BT Wi-Fi Account)"
				echo "$(date) Offline, attempting login URL 3 (BT Wi-Fi Account)" >> $LOGPATH
				wget -T 2 -O /dev/null --post-data "username=$USERNAME&password=$PASSWORD" 'https://192.168.23.21:8443/ante'
			fi
		fi
	fi
sleep 1
done
}

start() {
	logger -t BTWi-fi_Autologin_Service "$(date) BTWi-fi Autologin Service Started"
	echo "$(date) BTWi-fi Autologin Service Started" >> $LOGPATH
	[ -f $PIDFILE ] && [ ! -d /proc/`cat $PIDFILE` ] && rm $PIDFILE
	# ^---: check for a stale pidfile
	[ -f $PIDFILE ] && exit 1
	btwifi_loop &
	echo -n $! > $PIDFILE
}

stop() {
	kill `cat $PIDFILE`
	rm $PIDFILE
	wget -T 2 -O /dev/null 'https://192.168.23.21:8443/accountLogoff/home?confirmed=true'
	logger -t BTWi-fi_Autologin_Service "$(date) BTWi-fi Autologin Service Stopped Manually (Or Reboot)"
	echo "$(date) BTWi-fi Autologin Service Stopped Manually (Or Reboot)" >> $LOGPATH
}